<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rifa 100 N√∫meros ‚Äî Amaruki (Login + Tiempo real)</title>
  <style>
    :root{ --bg:#0b1020; --card:#121a33; --muted:#7f8db2; --accent:#2bb3ff; --accent2:#3ad1a1; --danger:#ff5c7a }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#e6ecff}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:12px 0 6px}
    .app{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.app{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(18,26,51,.95),rgba(10,15,30,.95));border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card h2{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;padding:14px}
    @media (max-width:520px){.grid{grid-template-columns:repeat(5,1fr)}}
    .num{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 0;text-align:center;font-weight:700;cursor:pointer;user-select:none}
    .num.available{background:linear-gradient(180deg,rgba(43,179,255,.12),rgba(43,179,255,.04))}
    .num.taken{background:linear-gradient(180deg,rgba(255,92,122,.18),rgba(255,92,122,.06));border-color:rgba(255,92,122,.45)}
    .alias-mini{font-size:10px;opacity:.85}
    .panel{padding:14px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button,textarea{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c1226;color:#eaf2ff;padding:10px 12px}
    button{cursor:pointer;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#04121c;font-weight:700}
    button.secondary{background:transparent;color:#e6ecff;border:1px solid rgba(255,255,255,.18)}
    .list{max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .tiny{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent)}
    .auth{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .avatar{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.18);object-fit:cover}
    .warn{background:#2a1320;border-color:#b74a62}
  </style>
</head>
<body>
  <div class="container">
    <h1>üéâ Rifa 100 N√∫meros ‚Äî Amaruki <span class="tiny">(login + tiempo real)</span></h1>
    <div class="app">
      <section class="card">
        <div class="panel" style="padding-bottom:0">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Selecciona un n√∫mero</h2>
            <div class="row">
              <span class="pill">Disponibles: <b id="available">100</b></span>
              <span class="pill">Reservados: <b id="taken">0</b></span>
            </div>
          </div>
        </div>
        <div class="grid" id="grid"></div>
      </section>

      <aside class="card">
        <div class="panel">
          <h2>Panel de control</h2>
          <div class="auth">
            <div id="userBox" style="display:none;align-items:center;gap:8px">
              <img id="userPhoto" class="avatar" alt=""/>
              <div>
                <div id="userName" style="font-weight:700"></div>
                <div id="userEmail" class="tiny"></div>
              </div>
              <button id="btnLogout" class="secondary" style="margin-left:auto">Salir</button>
            </div>
            <div id="authBox">
              <div class="row"><input id="email" placeholder="correo@ejemplo.com" style="flex:1"><input id="password" type="password" placeholder="Contrase√±a" style="flex:1"></div>
              <div class="row"><button id="btnLogin">Entrar</button><button id="btnRegister" class="secondary">Crear cuenta</button><button id="btnGoogle" class="secondary">Google</button></div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="row"><input id="alias" placeholder="Tu alias visible" style="flex:1"><button id="btnQuick">Reservar seleccionado</button></div>
          <div class="row"><input id="search" placeholder="Buscar alias o n√∫mero‚Ä¶" style="flex:1"><button id="btnExport" class="secondary">Exportar CSV</button></div>
          <div class="divider"></div>
          <div class="list" id="list"></div>
          <div class="divider"></div>
          <div>
            <h3 style="margin:0 0 6px">üèÜ Premios</h3>
            <div class="row"><input id="p1" placeholder="1¬∞ Premio" style="flex:1"></div>
            <div class="row"><input id="p2" placeholder="2¬∞ Premio" style="flex:1"></div>
            <div class="row"><input id="p3" placeholder="3¬∞ Premio" style="flex:1"></div>
          </div>
          <div class="divider"></div>
          <details>
            <summary class="tiny">‚öôÔ∏è Ajustes de sincronizaci√≥n (Firebase)</summary>
            <textarea id="cfg" rows="7" style="width:100%;margin-top:8px">{
  "apiKey": "AIzaSyAdhD7Lr-xxaaj5WHKUxtJjxwV8kT-ETi4",
  "authDomain": "rifa-90a26.firebaseapp.com",
  "databaseURL": "https://rifa-90a26-default-rtdb.firebaseio.com",
  "projectId": "rifa-90a26",
  "storageBucket": "rifa-90a26.firebasestorage.app",
  "messagingSenderId": "42485595611",
  "appId": "1:42485595611:web:ee2aa2410704a6af573bfe"
}</textarea>
            <div class="row"><button id="btnEnable">Habilitar Firebase</button><span class="tiny">Pega aqu√≠ tu JSON si necesitas cambiarlo</span></div>
          </details>
          <p class="tiny">Debes iniciar sesi√≥n para reservar n√∫meros. Si Firebase no est√° habilitado, funciona en modo local (s√≥lo en este navegador).</p>
        </div>
      </aside>
    </div>
  </div>

  <template id="tplItem">
    <div class="item"><div><b>#<span class="no"></span></b> ‚Äî <span class="alias"></span> <span class="tiny" style="opacity:.8">(<span class="uid"></span>)</span></div><button class="secondary btnFree">Liberar</button></div>
  </template>

  <script>
    // ===== Estado =====
    const TOTAL=100; 
    const state={numbers:{}, prizes:{p1:"",p2:"",p3:""}, backend:'local', fb:{app:null,db:null,auth:null,ref:null}, user:null};
    const el={grid:by('grid'), list:by('list'), available:by('available'), taken:by('taken'), alias:by('alias'), search:by('search'), p1:by('p1'), p2:by('p2'), p3:by('p3'), tpl:by('tplItem'), email:by('email'), password:by('password'), btnLogin:by('btnLogin'), btnRegister:by('btnRegister'), btnGoogle:by('btnGoogle'), btnLogout:by('btnLogout'), authBox:by('authBox'), userBox:by('userBox'), userName:by('userName'), userEmail:by('userEmail'), userPhoto:by('userPhoto'), btnEnable:by('btnEnable'), cfg:by('cfg'), btnQuick:by('btnQuick'), btnExport:by('btnExport')};

    function by(id){return document.getElementById(id)}

    // ===== Local init =====
    function build(){const n={};for(let i=1;i<=TOTAL;i++) n[i]=null;return {numbers:n,prizes:{...state.prizes}}}
    function load(){try{const x=localStorage.getItem('rifa_login_v1');return x?JSON.parse(x):null}catch(e){return null}}
    function save(){try{localStorage.setItem('rifa_login_v1',JSON.stringify({numbers:state.numbers,prizes:state.prizes}))}catch(e){}}

    function apply(snap,{silent}={}){state.numbers=snap.numbers||{};state.prizes=snap.prizes||{p1:"",p2:"",p3:""};render(); if(!silent && state.backend==='local') save();}

    function init(){const x=load(); apply(x||build(),{silent:true}); render();}

    // ===== Render =====
    function render(){ renderCounts(); renderGrid(); renderList(); el.p1.value=state.prizes.p1||''; el.p2.value=state.prizes.p2||''; el.p3.value=state.prizes.p3||''; }
    function renderCounts(){const t=Object.values(state.numbers).filter(v=>v).length; el.taken.textContent=t; el.available.textContent=TOTAL-t;}
    function renderGrid(){ el.grid.innerHTML=''; const term=(el.search.value||'').toLowerCase(); for(let i=1;i<=TOTAL;i++){const v=state.numbers[i]; const d=document.createElement('div'); d.className='num '+(v?'taken':'available'); d.innerHTML=`${i}<div class="alias-mini">${v?escapeHtml(v.alias):''}</div>`; if(term){const m=(''+i).includes(term)|| (v&&v.alias.toLowerCase().includes(term)); d.style.opacity=m?1:.35;} d.onclick=()=>onNumber(i); el.grid.appendChild(d);} }
    function renderList(){ el.list.innerHTML=''; const frag=document.createDocumentFragment(); Object.entries(state.numbers).filter(([n,v])=>v).sort((a,b)=>a[0]-b[0]).forEach(([no,obj])=>{ const node=el.tpl.content.firstElementChild.cloneNode(true); node.querySelector('.no').textContent=no; node.querySelector('.alias').textContent=obj.alias; node.querySelector('.uid').textContent=(obj.uid||'local').slice(0,6); const can=canRelease(obj); const btn=node.querySelector('.btnFree'); btn.disabled=!can; btn.onclick=()=>release(parseInt(no)); frag.appendChild(node); }); el.list.appendChild(frag); }

    function onNumber(no){ const cur=state.numbers[no]; if(cur){ if(state.backend==='firebase' && !canRelease(cur)){ alert('Solo el due√±o o un admin puede liberar.'); return;} if(confirm(`Liberar #${no}?`)) release(no); return; }
      const a=(el.alias.value||'').trim(); if(!a){ alert('Escribe tu alias.'); el.alias.focus(); return;} reserve(no,a); }

    function reserve(no,alias){ const uid=state.user?state.user.uid:'local'; const obj={alias,uid}; state.numbers[no]=obj; render(); if(state.backend==='firebase') setNumber(no,obj); else save(); }
    function release(no){ const cur=state.numbers[no]; if(!cur) return; if(state.backend==='firebase' && !canRelease(cur)) return; state.numbers[no]=null; render(); if(state.backend==='firebase') setNumber(no,null); else save(); }
    function canRelease(obj){ if(!obj) return false; if(state.user && obj.uid===state.user.uid) return true; return false; }

    // CSV
    el.btnExport.onclick=()=>{ const rows=[["numero","alias","uid"],...Object.entries(state.numbers).filter(([n,v])=>v).map(([n,v])=>[n,v.alias,v.uid||'local'])]; const csv=rows.map(r=>r.map(x=>`"${(x+"").replaceAll('"','\"')}"`).join(',')).join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='rifa.csv'; a.click(); URL.revokeObjectURL(url); };

    // Search
    el.search.addEventListener('input',()=>{renderGrid();renderList();});
    el.btnQuick.onclick=()=>{ const a=(el.alias.value||'').trim(); if(!a){alert('Escribe tu alias.'); return;} alert('Toca en la cuadr√≠cula el n√∫mero que quieres.'); };

    // ===== Firebase =====
    el.btnEnable.onclick=enableFb;
    async function enableFb(){ try{ const cfg=JSON.parse(el.cfg.value.trim()); await ensureFb(); const app=firebase.initializeApp(cfg); const db=firebase.database(); const auth=firebase.auth(); const ref=db.ref('rifa100/default'); state.backend='firebase'; state.fb={app,db,auth,ref}; // init if empty
      ref.child('snapshot').get().then(s=>{ if(!s.exists()) ref.child('snapshot').set(build()); });
      ref.child('snapshot').on('value',s=>{ if(s.exists()) apply(s.val(),{silent:true}); render(); });
      auth.onAuthStateChanged(u=>{ state.user=u||null; updateAuthUI(); if(u && !el.alias.value){ el.alias.value=u.displayName|| (u.email?u.email.split('@')[0]:''); }});
      alert('Firebase habilitado. Inicia sesi√≥n.');
    }catch(e){ alert('No se pudo habilitar Firebase. Revisa el JSON.\\n'+e); } }

    function setNumber(no,obj){ state.fb.ref.child(`snapshot/numbers/${no}`).set(obj); }

    function updateAuthUI(){ const u=state.user; if(u){ el.authBox.style.display='none'; el.userBox.style.display='flex'; el.userName.textContent=u.displayName|| (u.email?u.email.split('@')[0]:''); el.userEmail.textContent=u.email||''; el.userPhoto.src=u.photoURL||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="%23121a33"/><text x="50%" y="54%" fill="white" font-family="Arial" font-size="22" text-anchor="middle">üë§</text></svg>'; }
      else { el.authBox.style.display='block'; el.userBox.style.display='none'; } }

    // Auth buttons
    el.btnLogin.onclick=async ()=>{ try{ await ensureFb(); await firebase.auth().signInWithEmailAndPassword(el.email.value, el.password.value); }catch(e){ alert('Error al iniciar sesi√≥n: '+e.message);} };
    el.btnRegister.onclick=async ()=>{ try{ await ensureFb(); const cred=await firebase.auth().createUserWithEmailAndPassword(el.email.value, el.password.value); if(cred.user && !cred.user.displayName){ await cred.user.updateProfile({displayName: el.email.value.split('@')[0]}); } }catch(e){ alert('No se pudo crear la cuenta: '+e.message);} };
    el.btnGoogle.onclick=async ()=>{ try{ await ensureFb(); const provider=new firebase.auth.GoogleAuthProvider(); await firebase.auth().signInWithPopup(provider); }catch(e){ alert('Error con Google: '+e.message);} };
    el.btnLogout.onclick=async ()=>{ try{ await firebase.auth().signOut(); }catch(e){ alert('Error al salir: '+e.message);} };

    async function ensureFb(){ if(window.firebase) return; await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js'); await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js'); await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js'); }
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

    function escapeHtml(str){ return str.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // Boot
    init();
  </script>
</body>
</html>
