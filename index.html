<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rifa 100 N√∫meros ‚Äî Amaruki (Aprobaci√≥n por Admin)</title>
  <style>
    :root{ --bg:#0b1020; --card:#121a33; --muted:#7f8db2; --accent:#2bb3ff; --accent2:#3ad1a1; --danger:#ff5c7a; --pending:#f3c969 }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1020;color:#e6ecff}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:12px 0 6px}
    .app{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.app{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(18,26,51,.95),rgba(10,15,30,.95));border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card h2{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;padding:14px}
    @media (max-width:520px){.grid{grid-template-columns:repeat(5,1fr)}}
    .num{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 0;text-align:center;font-weight:700;cursor:pointer;user-select:none}
    .num.available{background:linear-gradient(180deg,rgba(43,179,255,.12),rgba(43,179,255,.04))}
    .num.pending{background:linear-gradient(180deg,rgba(243,201,105,.22),rgba(243,201,105,.06));border-color:rgba(243,201,105,.5)}
    .num.taken{background:linear-gradient(180deg,rgba(255,92,122,.18),rgba(255,92,122,.06));border-color:rgba(255,92,122,.45)}
    .alias-mini{font-size:10px;opacity:.9}
    .panel{padding:14px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button,textarea{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c1226;color:#eaf2ff;padding:10px 12px}
    button{cursor:pointer;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#04121c;font-weight:700}
    button.secondary{background:transparent;color:#e6ecff;border:1px solid rgba(255,255,255,.18)}
    .list{max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .tiny{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent)}
    .auth{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .avatar{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,.18);object-fit:cover}
    .warn{background:#2a1320;border-color:#b74a62}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(243,201,105,.18);border:1px solid rgba(243,201,105,.4);color:#ffeec0}
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">üéâ Rifa 100 N√∫meros ‚Äî Amaruki <span class="tiny">(aprobaci√≥n por administrador)</span></h1>
    <div class="app">
      <section class="card">
        <div class="panel" style="padding-bottom:0">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Selecciona un n√∫mero</h2>
            <div class="row">
              <span class="pill">Disponibles: <b id="available">100</b></span>
              <span class="pill">Reservados: <b id="taken">0</b></span>
            </div>
          </div>
        </div>
        <div class="grid" id="grid"></div>
      </section>
      </div>
    
    <!-- Panel lateral: usuario y administraci√≥n -->
    <section class="card" id="side-panel">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Panel</h2>
          <span class="tag" id="roleTag">Invitado</span>
        </div>

        <div class="divider"></div>

        <!-- Bloque Usuario (siempre visible) -->
        <div id="user-block">
          <h3 style="margin:0 0 6px">Reservar n√∫mero</h3>
          <div class="tiny">Selecciona un n√∫mero en la grilla y completa tus datos.</div>
          <div class="row">
            <input id="alias" placeholder="Tu nombre o alias" style="flex:1"/>
          </div>
          <div class="row">
            <button id="btnReserve">Reservar selecci√≥n</button>
            <button class="secondary" id="btnClear">Limpiar selecci√≥n</button>
          </div>
          <div class="tiny" id="selectionHint">Ning√∫n n√∫mero seleccionado</div>
        </div>

        <div class="divider"></div>

        <!-- Bloque Login Admin (visible si no est√° logueado) -->
        <div id="login-block">
          <h3 style="margin:0 0 6px">Modo administrador</h3>
          <div class="row">
            <input id="adminEmail" placeholder="Correo admin" value="" style="flex:1"/>
            <input id="adminPass" placeholder="Contrase√±a" type="password" style="flex:1"/>
          </div>
          <div class="row">
            <button id="btnLogin">Entrar como admin</button>
          </div>
          <div class="tiny">El panel de control aparece al iniciar sesi√≥n.</div>
        </div>

        <!-- Bloque Panel Admin (oculto por defecto) -->
        <div id="admin-panel" class="hidden">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">Panel de control</h3>
            <button class="secondary" id="btnLogout">Salir</button>
          </div>
          <div class="row">
            <span class="pill">Pendientes: <b id="pendingCount">0</b></span>
            <span class="pill">Aprobados: <b id="approvedCount">0</b></span>
          </div>

          <div class="list" id="pendingList"></div>

          <details id="sync-settings" style="margin-top:8px">
            <summary class="tiny">Ajustes de sincronizaci√≥n (solo admin)</summary>
            <div class="row">
              <button class="secondary" id="btnReset">Reiniciar rifa</button>
              <button class="secondary" id="btnExport">Exportar estado</button>
              <input id="importInput" type="file" accept="application/json"/>
            </div>
          </details>
        </div>
      </div>
    </section>
  </div>
  <script>
    const TOTAL = 100;
    const grid = document.getElementById('grid');
    const availableEl = document.getElementById('available');
    const takenEl = document.getElementById('taken');
    const selectionHint = document.getElementById('selectionHint');
    const aliasInput = document.getElementById('alias');
    const btnReserve = document.getElementById('btnReserve');
    const btnClear = document.getElementById('btnClear');

    const roleTag = document.getElementById('roleTag');
    const loginBlock = document.getElementById('login-block');
    const adminPanel = document.getElementById('admin-panel');
    const adminEmailInp = document.getElementById('adminEmail');
    const adminPassInp = document.getElementById('adminPass');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    const pendingCount = document.getElementById('pendingCount');
    const approvedCount = document.getElementById('approvedCount');
    const pendingList = document.getElementById('pendingList');

    const btnReset = document.getElementById('btnReset');
    const btnExport = document.getElementById('btnExport');
    const importInput = document.getElementById('importInput');

    const ADMIN_EMAIL = 'hijodenewton3.14@gmail.com';
    const ADMIN_PASS = '1234';

    const LS_KEY = 'amaruki_rifa_state_v1';

    let selectedNumber = null;
    let state = loadState();

    function initialState(){
      return {
        numbers: Array.from({length: TOTAL}, (_,i)=>({ n:i+1, status:'available', alias:null, by:null })),
        pending: [], // {n, alias, by, ts}
        approved: [], // {n, alias, by, ts}
        takenBy: {}, // n -> alias
        role: 'guest'
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return initialState();
        const parsed = JSON.parse(raw);
        // sane defaults if structure changed
        parsed.role = parsed.role || 'guest';
        parsed.pending = parsed.pending||[];
        parsed.approved = parsed.approved||[];
        parsed.takenBy = parsed.takenBy||{};
        if(!parsed.numbers || parsed.numbers.length!==TOTAL){
          parsed.numbers = initialState().numbers;
        }
        return parsed;
      }catch(e){
        return initialState();
      }
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function setRole(role){
      state.role = role; saveState();
      roleTag.textContent = role==='admin' ? 'Administrador' : 'Invitado';
      loginBlock.classList.toggle('hidden', role==='admin');
      adminPanel.classList.toggle('hidden', role!=='admin');
    }

    function renderCounts(){
      const available = state.numbers.filter(x=>x.status==='available').length;
      const taken = state.numbers.filter(x=>x.status==='taken').length;
      availableEl.textContent = available;
      takenEl.textContent = taken;
      pendingCount.textContent = state.pending.length;
      approvedCount.textContent = state.approved.length;
    }

    function renderGrid(){
      grid.innerHTML = '';
      state.numbers.forEach(info=>{
        const div = document.createElement('div');
        div.className = 'num ' + (info.status);
        div.innerHTML = `<div>${info.n}</div>${info.alias?`<div class="alias-mini">${info.alias}</div>`:''}`;
        div.onclick = ()=>{
          if(info.status!=='available' && state.role!=='admin') return; // invitados no seleccionan tomados/pending
          selectedNumber = info.n;
          selectionHint.textContent = `Seleccionado: #${selectedNumber}`;
        };
        grid.appendChild(div);
      });
    }

    function renderPending(){
      pendingList.innerHTML = '';
      if(state.pending.length===0){
        const empty = document.createElement('div');
        empty.className='item tiny';
        empty.textContent='No hay solicitudes pendientes';
        pendingList.appendChild(empty);
        return;
      }
      state.pending.forEach((p, idx)=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `<div>#${p.n} ‚Äî <b>${p.alias||'‚Äî'}</b> <span class="tiny">(${new Date(p.ts).toLocaleString()})</span></div>`;
        const actions = document.createElement('div');
        const approve = document.createElement('button');
        approve.textContent = 'Aprobar';
        approve.onclick = ()=> approveReservation(idx);
        const reject = document.createElement('button');
        reject.className='secondary';
        reject.textContent = 'Rechazar';
        reject.onclick = ()=> rejectReservation(idx);
        actions.appendChild(approve); actions.appendChild(reject);
        row.appendChild(actions);
        pendingList.appendChild(row);
      });
    }

    function approveReservation(idx){
      const req = state.pending[idx];
      if(!req) return;
      const num = state.numbers[req.n-1];
      if(num.status==='taken'){ // ya tomado por otro
        state.pending.splice(idx,1); saveAndRender();
        return;
      }
      num.status='taken';
      num.alias=req.alias;
      state.takenBy[num.n]=req.alias;
      state.approved.push({...req});
      state.pending.splice(idx,1);
      saveAndRender();
    }

    function rejectReservation(idx){
      const req = state.pending[idx];
      if(!req) return;
      const num = state.numbers[req.n-1];
      if(num.status==='pending'){
        num.status='available';
        num.alias=null;
      }
      state.pending.splice(idx,1);
      saveAndRender();
    }

    function saveAndRender(){ saveState(); renderCounts(); renderGrid(); renderPending(); }

    // acciones usuario
    btnReserve.onclick = ()=>{
      if(selectedNumber===null){ selectionHint.textContent='Selecciona un n√∫mero en la grilla'; return; }
      const alias = (aliasInput.value||'').trim();
      const num = state.numbers[selectedNumber-1];
      if(!num || num.status!=='available'){ selectionHint.textContent='Ese n√∫mero no est√° disponible'; return; }
      num.status='pending';
      num.alias=alias||'Reservado';
      state.pending.push({ n:selectedNumber, alias:num.alias, by:'guest', ts:Date.now() });
      selectedNumber=null; aliasInput.value=''; selectionHint.textContent='Solicitud enviada. Espera la aprobaci√≥n.';
      saveAndRender();
    };
    btnClear.onclick = ()=>{ selectedNumber=null; selectionHint.textContent='Ning√∫n n√∫mero seleccionado'; };

    // auth admin
    btnLogin.onclick = ()=>{
      const e = (adminEmailInp.value||'').trim();
      const p = (adminPassInp.value||'').trim();
      if(e===ADMIN_EMAIL && p===ADMIN_PASS){
        setRole('admin');
      } else {
        alert('Credenciales inv√°lidas');
      }
    };
    btnLogout.onclick = ()=>{ setRole('guest'); };

    // utilidades admin
    btnReset.onclick = ()=>{
      if(confirm('¬øSeguro que deseas reiniciar toda la rifa?')){
        state = initialState();
        setRole('admin');
        saveAndRender();
      }
    };
    btnExport.onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'estado_rifa_amaruki.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };
    importInput.onchange = (ev)=>{
      const file = ev.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data.numbers){ throw new Error('Archivo inv√°lido'); }
          state = data; saveAndRender();
          setRole('admin');
        }catch(err){ alert('No se pudo importar: '+err.message); }
      };
      reader.readAsText(file);
    };

    // helpers UI
    function initLayout(){
      // si ya estaba logueado antes, respeta rol
      setRole(state.role||'guest');
      renderCounts();
      renderGrid();
      renderPending();
    }

    // estilos utilitarios
    const style = document.createElement('style');
    style.innerHTML = `.hidden{display:none}`;
    document.head.appendChild(style);

    initLayout();
  </script>
</body>
</html>
