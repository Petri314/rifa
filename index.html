<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Digital 1-100 (Tiempo Real)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para la paleta de colores y responsividad */
        :root {
            --color-blue-deep: #1e90ff; /* Azul profundo */
            --color-gold-accent: #ffd700; /* Dorado para acentos */
            --color-green-available: #d0f0c0; /* Verde claro disponible */
            --color-red-occupied: #ff6666; /* Rojo ocupado */
            --color-bg-light: #f0f8ff; /* Fondo azul muy claro */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-light);
            min-height: 100vh;
        }
        .raffle-number {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .raffle-number:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        /* Colores de estado */
        .available {
            background-color: var(--color-green-available);
            color: #1e403d; /* Texto oscuro para contraste */
        }
        .occupied {
            background-color: var(--color-red-occupied);
            color: #ffffff;
            cursor: default;
        }
        /* Contenedor principal de la cuadr√≠cula */
        #raffle-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 columnas en m√≥vil */
            gap: 8px;
        }
        @media (min-width: 768px) {
            #raffle-grid {
                grid-template-columns: repeat(10, 1fr); /* 10 columnas en escritorio */
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">
            <span class="text-yellow-500">üèÜ</span> Rifa de los 100 N√∫meros <span class="text-blue-600">üéâ</span>
        </h1>
        <p class="text-lg text-gray-600 mt-2">¬°Selecciona tu n√∫mero de la suerte!</p>
    </header>

    <!-- Contenedor Principal: Panel y Grid -->
    <main class="flex flex-col md:flex-row gap-8 max-w-7xl mx-auto">

        <!-- Panel Lateral/Superior de Control y Estad√≠sticas -->
        <div id="sidebar" class="md:w-1/3 p-6 bg-white rounded-xl shadow-lg order-2 md:order-1 sticky top-8 h-fit">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-600">Panel de Rifa</h2>

            <!-- Contador de Disponibles -->
            <div class="bg-blue-100 p-4 rounded-lg mb-4 flex justify-between items-center shadow-inner">
                <span class="font-semibold text-gray-700">N√∫meros Disponibles:</span>
                <span id="available-count" class="text-3xl font-extrabold text-blue-700">100</span>
            </div>

            <!-- Bot√≥n de Reinicio -->
            <button id="reset-raffle-btn" class="w-full py-3 mb-6 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl transition shadow-md">
                Reiniciar Rifa (Nueva Rifa)
            </button>
            
            <!-- Indicador de Usuario y Estado -->
            <div class="text-sm text-gray-500 mb-4 border-t pt-4">
                <p>ID de Sesi√≥n (Tu ID): <span id="user-id-display" class="font-mono text-xs break-all text-gray-700">Cargando...</span></p>
                <p id="loading-indicator" class="text-orange-500 mt-2 font-semibold">Conectando a la base de datos...</p>
            </div>


            <!-- Lista de Participantes -->
            <h3 class="text-xl font-bold mt-4 mb-3 text-gray-800">Lista de Participantes</h3>
            <div id="participants-list-container" class="max-h-96 overflow-y-auto pr-2">
                <ul id="participants-list" class="space-y-2">
                    <li class="text-gray-500">A√∫n no hay n√∫meros seleccionados.</li>
                </ul>
            </div>
        </div>

        <!-- Cuadr√≠cula de N√∫meros -->
        <div class="md:w-2/3 order-1 md:order-2">
            <div id="raffle-grid" class="p-4 bg-white rounded-xl shadow-lg">
                <!-- Los n√∫meros se renderizar√°n aqu√≠ -->
            </div>
        </div>

    </main>
    
    <!-- Recuadro de Premios -->
    <div class="max-w-7xl mx-auto mt-12 mb-8 p-6 bg-yellow-50 border-t-4 border-yellow-400 rounded-xl shadow-xl">
        <h2 class="text-3xl font-extrabold text-yellow-700 mb-4 flex items-center">
            üèÜ Premios de la Rifa:
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-700 font-semibold">
            <p class="p-3 bg-yellow-100 rounded-lg">1¬∞ Premio: <span class="text-yellow-900">[**Bicicleta de Monta√±a**]</span></p>
            <p class="p-3 bg-yellow-100 rounded-lg">2¬∞ Premio: <span class="text-yellow-900">[**Consola de Videojuegos**]</span></p>
            <p class="p-3 bg-yellow-100 rounded-lg">3¬∞ Premio: <span class="text-yellow-900">[**Cesta de Productos Gourmet**]</span></p>
        </div>
    </div>


    <!-- Contenedor para la l√≥gica de Firebase y la aplicaci√≥n -->
    <script type="module">
        // Importaciones de Firebase (Necesarias para la funcionalidad de tiempo real)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================
        // 1. Configuraci√≥n de Firebase y Autenticaci√≥n
        // =======================================================

        const RAFFLE_COLLECTION = 'raffle_numbers';
        const RAFFLE_DOC_ID = 'raffle_state';
        
        let db;
        let auth;
        let userId = 'loading';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-raffle-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Inicializa Firebase, autentica al usuario y comienza a escuchar la base de datos.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticaci√≥n: usar token personalizado o iniciar sesi√≥n de forma an√≥nima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('user-id-display').textContent = userId;
                document.getElementById('loading-indicator').textContent = 'Conectado. ¬°Buena suerte!';
                document.getElementById('loading-indicator').classList.replace('text-orange-500', 'text-green-600');
                
                // 2. Comienza a escuchar los cambios en la base de datos
                listenToRaffleState();

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('loading-indicator').textContent = 'Error de conexi√≥n. Intenta recargar.';
                document.getElementById('loading-indicator').classList.replace('text-orange-500', 'text-red-600');
            }
        }

        /**
         * Genera la ruta de Firestore para datos p√∫blicos de esta aplicaci√≥n.
         */
        function getRaffleDocRef() {
            const path = `/artifacts/${appId}/public/data/${RAFFLE_COLLECTION}`;
            return doc(collection(db, path), RAFFLE_DOC_ID);
        }

        // =======================================================
        // 2. L√≥gica de Estado y Real-Time
        // =======================================================
        
        const NUM_COUNT = 100;
        let currentRaffleState = {};
        
        /**
         * Genera el estado inicial de la rifa (todos disponibles).
         */
        function generateInitialState() {
            const numbers = {};
            for (let i = 1; i <= NUM_COUNT; i++) {
                numbers[i] = {
                    number: i,
                    occupied: false,
                    participant: null,
                    userId: null
                };
            }
            return { 
                numbers: numbers,
                availableCount: NUM_COUNT
            };
        }

        /**
         * Configura el listener de tiempo real (onSnapshot) de Firestore.
         */
        function listenToRaffleState() {
            const docRef = getRaffleDocRef();
            
            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentRaffleState = docSnapshot.data();
                } else {
                    // Si el documento no existe (primera vez o despu√©s de un reset), cr√©alo.
                    currentRaffleState = generateInitialState();
                    setDoc(docRef, currentRaffleState).catch(console.error);
                }
                // Actualiza la UI con el nuevo estado
                renderRaffleUI(currentRaffleState);
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
            });
        }

        // =======================================================
        // 3. Renderizado de la UI
        // =======================================================

        const gridElement = document.getElementById('raffle-grid');
        const countElement = document.getElementById('available-count');
        const listElement = document.getElementById('participants-list');
        
        /**
         * Renderiza la cuadr√≠cula de n√∫meros y el panel de control.
         */
        function renderRaffleUI(state) {
            if (!state || !state.numbers) return;
            
            const numbers = Object.values(state.numbers).sort((a, b) => a.number - b.number);
            const availableCount = numbers.filter(n => !n.occupied).length;
            countElement.textContent = availableCount;

            gridElement.innerHTML = '';
            listElement.innerHTML = '';
            const participants = [];

            numbers.forEach(item => {
                const isOccupied = item.occupied;
                const numberDiv = document.createElement('div');
                numberDiv.className = `raffle-number h-12 text-lg ${isOccupied ? 'occupied' : 'available'}`;
                numberDiv.textContent = item.number;
                numberDiv.setAttribute('data-number', item.number);
                
                if (!isOccupied) {
                    numberDiv.onclick = () => handleNumberClick(item.number);
                }

                gridElement.appendChild(numberDiv);

                if (isOccupied) {
                    participants.push(item);
                }
            });

            // Renderizar la lista de participantes
            if (participants.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500">A√∫n no hay n√∫meros seleccionados.</li>';
            } else {
                participants.sort((a, b) => a.number - b.number);
                participants.forEach(p => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg shadow-sm';
                    listItem.innerHTML = `
                        <span class="font-bold text-blue-600">${p.number}</span>
                        <span class="text-sm font-medium text-gray-700">${p.participant}</span>
                    `;
                    listElement.appendChild(listItem);
                });
            }
        }

        // =======================================================
        // 4. Funciones de Interacci√≥n y Transacci√≥n
        // =======================================================

        /**
         * Maneja el click en un n√∫mero disponible.
         */
        function handleNumberClick(number) {
            // Utilizamos un input personalizado en lugar de prompt()
            const name = prompt("¬°Introduce tu nombre o alias para el n√∫mero " + number + "!");
            
            if (name && name.trim()) {
                selectNumber(number, name.trim());
            } else {
                // Notificaci√≥n simple en caso de que el usuario cancele o no introduzca nada
                console.log("Selecci√≥n cancelada o nombre no proporcionado.");
            }
        }

        /**
         * Ejecuta una transacci√≥n para marcar un n√∫mero como ocupado.
         */
        async function selectNumber(number, participantName) {
            const docRef = getRaffleDocRef();
            const numberKey = number.toString();
            
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    let state;

                    if (!docSnapshot.exists()) {
                        // Si el documento se borr√≥ justo antes, inicializa
                        state = generateInitialState();
                    } else {
                        state = docSnapshot.data();
                    }

                    // Prevenir doble selecci√≥n
                    if (state.numbers[numberKey] && state.numbers[numberKey].occupied) {
                        alert("¬°Este n√∫mero acaba de ser seleccionado por otro participante! Elige otro.");
                        return Promise.reject("N√∫mero ya ocupado"); // Rechazar la transacci√≥n
                    }

                    // Actualizar el estado
                    if (state.numbers[numberKey]) {
                        state.numbers[numberKey] = {
                            number: number,
                            occupied: true,
                            participant: participantName,
                            userId: userId
                        };
                        state.availableCount = Object.values(state.numbers).filter(n => !n.occupied).length;

                        // Guardar la actualizaci√≥n
                        transaction.set(docRef, state);
                    }
                });
                console.log(`N√∫mero ${number} seleccionado por ${participantName}.`);
            } catch (e) {
                console.error("Fallo en la transacci√≥n de selecci√≥n:", e);
                // Si el error no es el rechazo de "N√∫mero ya ocupado", mostrar un mensaje general.
                if (e !== "N√∫mero ya ocupado") {
                    alert("Hubo un error al intentar seleccionar el n√∫mero. Revisa la consola.");
                }
            }
        }

        /**
         * Reinicia completamente la rifa.
         */
        async function resetRaffle() {
            if (!confirm('¬øEst√°s seguro de que quieres REINICIAR completamente la rifa? Esto borrar√° todos los n√∫meros seleccionados.')) {
                return;
            }

            const docRef = getRaffleDocRef();
            const initialState = generateInitialState();

            try {
                await setDoc(docRef, initialState);
                alert("¬°Rifa reiniciada con √©xito! Todos los n√∫meros est√°n disponibles nuevamente.");
            } catch (error) {
                console.error("Error al reiniciar la rifa:", error);
                alert("No se pudo reiniciar la rifa. Revisa la consola para m√°s detalles.");
            }
        }

        // =======================================================
        // 5. Inicializaci√≥n
        // =======================================================

        document.getElementById('reset-raffle-btn').onclick = resetRaffle;
        
        // Inicializar la aplicaci√≥n cuando la p√°gina est√© lista
        window.onload = initializeFirebase;

    </script>
</body>
</html>